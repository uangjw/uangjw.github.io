<!DOCTYPE html><html lang="zh-cmn-Hans" prefix="og: http://ogp.me/ns#" class="han-init"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" /><title>论文笔记/复现||python-opencv实现数字绘画重打光（relighting） &mdash; Bird Nest</title><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/uangjw/uangjw.github.io@master/assets/vendor/primer-css/css/primer.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/uangjw/uangjw.github.io@master/assets/css/components/collection.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/uangjw/uangjw.github.io@master/assets/css/components/repo-card.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/uangjw/uangjw.github.io@master/assets/css/sections/repo-list.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/uangjw/uangjw.github.io@master/assets/css/components/boxed-group.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/uangjw/uangjw.github.io@master/assets/css/globals/common.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/uangjw/uangjw.github.io@master/assets/css/globals/responsive.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/uangjw/uangjw.github.io@master/assets/css/posts/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/uangjw/uangjw.github.io@master/assets/vendor/octicons/octicons/octicons.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/mzlogin/rouge-themes@master/dist/github.css"><link rel="canonical" href="https://uangjw.github.io/2021/03/01/reproduction-PaintingLight/"><link rel="alternate" type="application/atom+xml" title="Bird Nest" href="https://uangjw.github.io"><link rel="shortcut icon" href="https://cdn.jsdelivr.net/gh/uangjw/uangjw.github.io@master/favicon.ico"><meta property="og:title" content="论文笔记/复现||python-opencv实现数字绘画重打光（relighting）"><meta name="keywords" content="python, opencv"><meta name="og:keywords" content="python, opencv"><meta name="description" content="​ Project PaintingLight(https://github.com/lllyasviel/PaintingLight) 通过色彩几何（color geometry）的方法实现了对数字绘画进行重打光（relighting）的功能；算法的核心在于定义并测量了图像的笔触密度（stroke density），从而以此为基础生成与给定光源位置对应的打光效果。整个项目可以大致分为定义并测量笔触密度、生成大致光照图像以及生成最终图像三个部分。"><meta name="og:description" content="​ Project PaintingLight(https://github.com/lllyasviel/PaintingLight) 通过色彩几何（color geometry）的方法实现了对数字绘画进行重打光（relighting）的功能；算法的核心在于定义并测量了图像的笔触密度（stroke density），从而以此为基础生成与给定光源位置对应的打光效果。整个项目可以大致分为定义并测量笔触密度、生成大致光照图像以及生成最终图像三个部分。"><meta property="og:url" content="https://uangjw.github.io/2021/03/01/reproduction-PaintingLight/"><meta property="og:site_name" content="Bird Nest"><meta property="og:type" content="article"><meta property="og:locale" content="zh_CN" /><meta property="article:published_time" content="2021-03-01"> <script src="https://cdn.jsdelivr.net/gh/uangjw/uangjw.github.io@master/assets/vendor/jquery/dist/jquery.min.js"></script> <script src="https://cdn.jsdelivr.net/gh/uangjw/uangjw.github.io@master/assets/js/jquery-ui.js"></script> <script src="https://cdn.jsdelivr.net/gh/uangjw/uangjw.github.io@master/assets/js/main.js"></script></head><body class="" data-mz=""><header class="site-header"><div class="container"><h1><a href="https://uangjw.github.io/" title="Bird Nest"><span class="octicon octicon-mark-github"></span> Bird Nest</a></h1><button class="collapsed mobile-visible" type="button" onclick="toggleMenu();"> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span> </button><nav class="site-header-nav" role="navigation"> <a href="https://uangjw.github.io/" class=" site-header-nav-item" target="" title="Home">Home</a> <a href="https://uangjw.github.io/categories/" class=" site-header-nav-item" target="" title="Categories">Categories</a> <a href="https://uangjw.github.io/about/" class=" site-header-nav-item" target="" title="About">About</a></nav></div></header><section class="collection-head small geopattern" data-pattern-id="论文笔记/复现||python"><div class="container"><div class="columns"><div class="column three-fourths"><div class="collection-title"><h1 class="collection-header">论文笔记/复现||python-opencv实现数字绘画重打光（relighting）</h1><div class="collection-info"> <span class="meta-info"> <span class="octicon octicon-calendar"></span> 2021/03/01 </span> <span class="meta-info"> <span class="octicon octicon-file-directory"></span> <a href="https://uangjw.github.io/categories/#reproduction" title="reproduction">reproduction</a> </span> <span class="meta-info"> <span class="octicon octicon-file-directory"></span> <a href="https://uangjw.github.io/categories/#PaperNotes" title="PaperNotes">PaperNotes</a> </span> <span class="meta-info"> <span class="octicon octicon-file-directory"></span> <a href="https://uangjw.github.io/categories/#opencv" title="opencv">opencv</a> </span> <span class="meta-info"> <span class="octicon octicon-clock"></span> 共 2543 字，约 8 分钟 </span></div></div></div><div class="column one-fourth mobile-hidden"><div class="collection-title"></div></div></div></div></section><section class="container content"><div class="columns"><div class="column three-fourths" ><article class="article-content markdown-body"><p>​ Project PaintingLight(<a href="https://github.com/lllyasviel/PaintingLight">https://github.com/lllyasviel/PaintingLight</a>) 通过色彩几何（color geometry）的方法实现了对数字绘画进行重打光（relighting）的功能；算法的核心在于定义并测量了图像的笔触密度（stroke density），从而以此为基础生成与给定光源位置对应的打光效果。整个项目可以大致分为定义并测量笔触密度、生成大致光照图像以及生成最终图像三个部分。</p><ol><li><p>定义并测量笔触密度</p><p>​ 作者们发现在数字绘画的创作过程中大致有这样的规律：画家往往会通过用色彩不断“加深”的方式来绘制阴影的效果，即色彩混合程度较高的区域（用原文的话来说是“笔触历史较密集”的区域）通常就是阴影的区域。从这里我们也可以明显地看出，这一出发点将使得本算法对使用大色块绘制（flat）的数字绘画将无可奈何，而只对使用“厚涂”技法的作品能展现出最好的效果；进一步地，“厚涂”作品往往与真实照片接近，因此我们也可以推测本算法在对照片的重打光场景下也有施展的空间。</p><p>​ 作者将笔触密度stroke density定义如下：</p><p>​ \(k=\frac{1-\sqrt{\sum^n_{i=1}{\alpha^2_i}}}{1-\frac{1}{\sqrt{n}}}\)</p><p>​ 将组成源图像的所有色彩（像素值，一个色彩空间中的向量）的集合称为一个调色盘palette，那么其中的每一个特定的颜色实际上都可以由整个调色盘中的色彩值加权求和得到，上式中的$\alpha_i$就是这一“权值”。通过建立基于凸包的调色盘并利用其几何特性，简单推导后就可得到每一色彩$\boldsymbol{c}_p$与调色盘元素的关系如下：</p><table><tbody><tr><td>​ $$\begin{aligned}\boldsymbol{c}_p&amp;=(1-\frac{</td><td>\boldsymbol{c}_p-\boldsymbol{g}</td><td>}{</td><td>\boldsymbol{h}_p-\boldsymbol{g}</td><td>})\boldsymbol{g}+(\frac{</td><td>\boldsymbol{c}_p-\boldsymbol{g}</td><td>}{</td><td>\boldsymbol{h}_p-\boldsymbol{g}</td><td>})\boldsymbol{h}_p\&amp;=(\frac{\boldsymbol{c}_p-\boldsymbol{g}}{</td><td>\boldsymbol{h}_p-\boldsymbol{g}</td><td>})\boldsymbol{h}<em>p+\frac{1}{n}\sum^n</em>{i=1}{\frac{</td><td>\boldsymbol{c}_i-\boldsymbol{g}</td><td>}{</td><td>\boldsymbol{h}_i-\boldsymbol{g}</td><td>}}\end{aligned}$$</td></tr></tbody></table><p>上式中$\boldsymbol{g}$为调色盘的重心$\frac{1}{n}\sum^n_{i=1}{\boldsymbol{c}_i}$，$\boldsymbol{h}$为以$\boldsymbol{g}$为起点，经过特定像素值$\boldsymbol{c}_p$的射线与调色盘对应凸包的交点（坐标）。由上式可以看出，权值$\alpha$即为$\boldsymbol{c}_i$的系数，代入stroke density的定义式后可以得到表达式：</p><table><tbody><tr><td>​ $$k_p=\frac{</td><td>\boldsymbol{c}_p-\boldsymbol{g}</td><td>}{</td><td>\boldsymbol{h}_p-\boldsymbol{g}</td><td>}$$</td></tr></tbody></table><p>于是便可以估计得出源图像的stroke density分布。</p></li><li><p>生成大致光照图像</p><p>​ 作者注意到画家在绘制光影效果时往往先绘制出一个大致的忽略轮廓与边缘的光影效果，于是设计算法在生成光影效果时也同样地首先生成大致图像。在源代码中，作者使用高斯金字塔与sobel算子搭配来生成能体现微弱轮廓特征的大致的光照效果；此时暂未考虑光源位置的信息。在考虑光源位置对光照效果图像的影响时，作者指出</p><blockquote><p>Each peak of the wave function $n_i^*(\boldsymbol{l},\theta,p_d)$ has a side facing the light source and a side facing away from the light source. We can increase the intensity of the front side and reduce the intensity of the back side to simulate a light</p></blockquote><p>其中$\boldsymbol{l}$为光源位置的坐标，$\theta$与$p_d$是体现光源在图像上的投影坐标与特定像素坐标之间位置关系的变量。这一部分我暂时还是不太理解，看到作者在后文提到其做法类似shape-from-shadow algorithm，我想先了解一下后者，或许能够解开我这里的困惑。总之最终的做法是，将前述wave function的单位方向向量以及光源到待确定像素的单位方向向量做点乘运算，结果就是最终的考虑了光源位置的大致光照图像。</p></li><li><p>生成最终图像</p><p>​ 在生成最终图像时，根据笔触密度大处倾向于具有“高光”或“阴影”效果的规律，最终的光照效果图像$\boldsymbol{S}$可由下式计算得到：</p><p>​ \(\boldsymbol{S}_i=\gamma \boldsymbol{E}_i\odot \boldsymbol{K}+O\)</p><p>其中$\boldsymbol{E}$即已考虑了光源位置的大致光照效果图像，$\boldsymbol{K}$为各像素笔触密度stroke density的值所对应的灰度图像，$\gamma$为光照强度参数。$O$为环境强度参数（ambient intensity），其意义是在具有较小笔触密度值的区域模拟环境光的效果。在实际实现中，作者是先生成不考虑光源而考虑笔触密度的光照图像后再将其与用户鼠标指示的光源位置信息（光源坐标向量）作运算，得到最终的光照图像。渲染结果由光照图像与原图像各像素值对应相乘即得。</p><p>​ 大致运行结果如下。代码见<a href="https://github.com/uangjw/Reproduction-of-PaintingLight">https://github.com/uangjw/Reproduction-of-PaintingLight</a> <br /> <img src="https://cdn.jsdelivr.net/gh/uangjw/uangjw.github.io@master/images/RelightingResult.png" /></p></li></ol><div style="margin-top:2em;padding:0 1.5em;border:1px solid #d3d3d3;background-color:#deebf7"><h3>文档信息</h3><ul><li>本文作者：<a href="https://uangjw.github.io" target="_blank">Jingwen Huang</a></li><li>本文链接：<a href="https://uangjw.github.io/2021/03/01/reproduction-PaintingLight/" target="_blank">https://uangjw.github.io/2021/03/01/reproduction-PaintingLight/</a></li><li>版权声明：自由转载-非商用-非衍生-保持署名（<a href="http://creativecommons.org/licenses/by-nc-nd/3.0/deed.zh" target="_blank">创意共享3.0许可证</a>）</li></ul></div></article><div class="share"></div><div class="comment"></div></div><div class="column one-fourth"><h3>Search</h3><div id="site_search"> <input style="width:96%" type="text" id="search_box" placeholder="Search"></div><ul id="search_results" style="font-size:14px;list-style-type:none;padding-top:10px;padding-left:10px;"></ul><script src="https://cdn.jsdelivr.net/gh/uangjw/uangjw.github.io@master/assets/js/simple-jekyll-search.min.js"></script> <script type="text/javascript"> SimpleJekyllSearch({ searchInput: document.getElementById('search_box'), resultsContainer: document.getElementById('search_results'), json: 'https://uangjw.github.io/assets/search_data.json', searchResultTemplate: '<li><a href="{url}" title="{title}">{title}</a></li>', noResultsText: 'No results found', limit: 10, fuzzy: false, exclude: ['Welcome'] }) </script><h3 class="post-directory-title mobile-hidden">Table of Contents</h3><div id="post-directory-module" class="mobile-hidden"><section class="post-directory"><dl></dl></section></div><script src="https://cdn.jsdelivr.net/gh/uangjw/uangjw.github.io@master/assets/js/jquery.toc.js"></script></div></div></section><footer class="container"><div class="site-footer" role="contentinfo"><div class="copyright left mobile-block"> © 2021 <span title="Jingwen Huang">Jingwen Huang</span> <a href="javascript:window.scrollTo(0,0)" class="right mobile-visible">TOP</a></div><ul class="site-footer-links right mobile-hidden"><li> <a href="javascript:window.scrollTo(0,0)" >TOP</a></li></ul><a href="https://github.com/uangjw/uangjw.github.io" target="_blank" aria-label="view source code"> <span class="mega-octicon octicon-mark-github" title="GitHub"></span> </a><ul class="site-footer-links mobile-hidden"><li> <a href="https://uangjw.github.io/" title="Home" target="">Home</a></li><li> <a href="https://uangjw.github.io/categories/" title="Categories" target="">Categories</a></li><li> <a href="https://uangjw.github.io/about/" title="About" target="">About</a></li><li><a href="https://uangjw.github.io"><span class="octicon octicon-rss" style="color:orange;"></span></a></li></ul><script async src="https://cdn.jsdelivr.net/gh/uangjw/uangjw.github.io@master/assets/vendor/busuanzi/2.3/busuanzi.pure.mini.js"></script><div class="mobile-hidden" style="margin-top:8px"> <span id="busuanzi_container_site_pv" style="display:none"> 本站访问量<span id="busuanzi_value_site_pv"></span>次 </span> <span id="busuanzi_container_site_uv" style="display:none"> / 本站访客数<span id="busuanzi_value_site_uv"></span>人 </span> <span id="busuanzi_container_page_pv" style="display:none"> / 本页访问量<span id="busuanzi_value_page_pv"></span>次 / 统计始于2021-03-10 </span></div></div></footer><div class="tools-wrapper"> <a class="gotop" href="#" title="回到顶部"><span class="octicon octicon-arrow-up"></span></a></div><script src="https://cdn.jsdelivr.net/gh/uangjw/uangjw.github.io@master/assets/js/geopattern.js"></script> <script> jQuery(document).ready(function($) { $('.geopattern').each(function(){ $(this).geopattern($(this).data('pattern-id')); }); /* hljs.initHighlightingOnLoad(); */ }); </script><div style="display:none"> <script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','https://www.google-analytics.com/analytics.js','ga'); ga('create', 'UA-80669434-1', 'auto'); ga('send', 'pageview'); </script></div></body></html>
